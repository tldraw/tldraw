# Invitation System Design

## Overview

Each workspace (except private workspaces) has a single, persistent invitation link that can be enabled/disabled and manually regenerated by the workspace owner.

## Database Schema

```sql
CREATE TABLE invitation_links (
  id UUID PRIMARY KEY,
  workspace_id UUID NOT NULL UNIQUE,  -- One link per workspace
  token TEXT NOT NULL UNIQUE,          -- Persistent token
  enabled BOOLEAN NOT NULL DEFAULT true,
  created_by UUID NOT NULL,
  created_at TIMESTAMPTZ NOT NULL,
  regenerated_at TIMESTAMPTZ           -- Tracks when owner regenerates
);
```

### Key Constraints
- `workspace_id UNIQUE`: Enforces one invitation link per workspace
- `token UNIQUE`: Ensures no token collisions
- `ON DELETE CASCADE`: Link deleted when workspace is deleted

## Invitation Link Lifecycle

### 1. Creation
- **When**: First time owner accesses GET `/api/workspaces/:id/invite`
- **Initial State**: `enabled: false` (owner must explicitly enable)
- **Token**: Generated via `randomBytes(32).toString('base64url')` (secure, URL-safe)

### 2. Usage
- **URL Format**: `https://app.com/invite/:token`
- **Access**: Anyone with the link can attempt to join
- **Validation**:
  - ✅ Token must exist in database
  - ✅ Link must be enabled (`enabled: true`)
  - ✅ Workspace must not be deleted
  - ✅ User must be authenticated
  - ✅ User cannot already be a member
  - ✅ Workspace cannot exceed 100 member limit

### 3. Persistence
- **Token Stability**: Token remains the same indefinitely
- **Same Link**: Owner can share the same URL repeatedly
- **No Expiration**: Links do not expire (only disabled/regenerated)

### 4. Enable/Disable
- **Endpoint**: PATCH `/api/workspaces/:id/invite`
- **Toggle**: `{ "enabled": true/false }`
- **Effect**: When disabled, join attempts return 410 Gone error
- **Token**: Remains unchanged when toggling enabled state

### 5. Regeneration (Manual Re-roll)
- **Endpoint**: POST `/api/workspaces/:id/invite/regenerate`
- **Action**: Generates new random token
- **Effect**: Old link immediately becomes invalid (404)
- **Use Case**: Owner suspects link was leaked or wants to revoke access
- **Timestamp**: Updates `regenerated_at` for audit trail

## Private Workspaces

**Private workspaces cannot have invitation links.**

- Created automatically on user signup
- Non-deletable and non-renamable
- Single-user only
- All invitation endpoints return 403 Forbidden for private workspaces

## API Endpoints

### Get or Create Invitation Link
```http
GET /api/workspaces/:workspaceId/invite
Authorization: Required (Owner only)
```

**Response:**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "workspace_id": "uuid",
    "token": "secure-random-token",
    "enabled": false,
    "created_by": "uuid",
    "created_at": "2025-10-04T00:00:00Z",
    "regenerated_at": null
  }
}
```

### Enable/Disable Link
```http
PATCH /api/workspaces/:workspaceId/invite
Authorization: Required (Owner only)
Content-Type: application/json

{
  "enabled": true
}
```

### Regenerate Token
```http
POST /api/workspaces/:workspaceId/invite/regenerate
Authorization: Required (Owner only)
```

**Effect:** Generates new token, invalidates old link

### Join via Invitation
```http
POST /api/invite/:token/join
Authorization: Required (Authenticated user)
```

**Success Response:**
```json
{
  "success": true,
  "data": {
    "message": "Successfully joined workspace",
    "workspace_id": "uuid",
    "workspace_name": "Team Workspace"
  }
}
```

## Error Handling

| Error | HTTP Status | When |
|-------|-------------|------|
| `INVITATION_NOT_FOUND` | 404 | Token doesn't exist or was regenerated |
| `INVITATION_DISABLED` | 410 | Link exists but is disabled |
| `WORKSPACE_NOT_FOUND` | 404 | Workspace was deleted |
| `ALREADY_MEMBER` | 409 | User is already a workspace member |
| `WORKSPACE_MEMBER_LIMIT_EXCEEDED` | 422 | Workspace has 100 members |
| `UNAUTHORIZED` | 401 | User not authenticated |
| `FORBIDDEN` | 403 | Attempting to create link for private workspace |

## Security Considerations

1. **Token Security**: 32-byte random tokens provide ~256 bits of entropy
2. **URL-Safe Encoding**: base64url encoding prevents URL encoding issues
3. **Authentication Required**: Users must be logged in to join
4. **Owner-Only Management**: Only workspace owners can view/modify invitation links
5. **Member Limit**: Prevents abuse by capping workspace size at 100 members
6. **Audit Trail**: `regenerated_at` timestamp tracks when links are regenerated

## User Flow Example

1. **Owner creates shared workspace**
   - Workspace created with `is_private: false`
   - No invitation link exists yet

2. **Owner views workspace settings**
   - Frontend calls GET `/api/workspaces/:id/invite`
   - Backend creates invitation link with `enabled: false`
   - Returns link token

3. **Owner enables link**
   - Frontend calls PATCH `/api/workspaces/:id/invite` with `enabled: true`
   - Link becomes active

4. **Owner shares link**
   - Copies `https://app.com/invite/TOKEN` to clipboard
   - Shares via email/Slack/etc.
   - Same link works for all invitees

5. **Invitee joins**
   - Clicks link → redirected to `/invite/:token`
   - If not logged in → redirected to login (token preserved)
   - After authentication → POST `/api/invite/:token/join`
   - Automatically added as workspace member

6. **Owner suspects leak**
   - Calls POST `/api/workspaces/:id/invite/regenerate`
   - New token generated, old link stops working
   - Shares new link

## Implementation Notes

- Invitation links are **lazy-created** on first GET (not during workspace creation)
- The `invitation_links` table uses `workspace_id` as a unique constraint, not as the primary key
- This allows for potential future enhancement (e.g., multiple link types) without schema changes
- Token generation uses Node.js `crypto.randomBytes()` for cryptographic security

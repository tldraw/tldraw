name: Issue Triage

on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to triage (for testing)'
        required: true
        type: number

jobs:
  triage:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write
    env:
      ISSUE_NUMBER: ${{ github.event.issue.number || inputs.issue_number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Get issue details
        id: issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue view ${{ env.ISSUE_NUMBER }} --json title,body,labels,state > /tmp/issue.json
          echo "details<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/issue.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Triage Issue with Claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are an issue triage bot for the tldraw repository. Evaluate and label issue #${{ env.ISSUE_NUMBER }}.

            ## Issue details
            ```json
            ${{ steps.issue.outputs.details }}
            ```

            ## Tasks

            ### 1. Classify the issue type
            Determine if this is a:
            - **Bug**: Something is broken or not working as designed (crashes, rendering errors, data loss)
            - **Improvement**: A request to enhance existing behavior (UX preferences, "I wish X worked like Y")
            - **Feature**: A request for entirely new functionality
            - **Task**: Internal team task
            - **Example**: Request for a new SDK example

            IMPORTANT: Many issues filed as "bugs" are actually improvement requests. A true bug is something objectively broken. "The menu should be on the left" or "I don't like the animation" are improvements, not bugs.

            ### 2. Apply labels
            Add appropriate labels using `gh issue edit --add-label`:
            - `sdk` - Affects @tldraw/tldraw package
            - `dotcom` - Related to tldraw.com
            - `docs` - Documentation changes
            - `examples` - SDK example requests
            - `performance` - Performance issues
            - `a11y` - Accessibility issues
            - `bugfix` - Confirmed bugs (use only for TRUE bugs)
            - `feature` - New features
            - `improvement` - Product improvements (use this for UX preferences)
            - `More Info Needed` - Issue lacks critical info to understand/reproduce

            ## Output format
            After your analysis:
            1. If labels need to be added, use `gh issue edit` to add them
            2. If the type needs to be changed, update it accordingly
            3. If no changes are needed, you can simply acknowledge the issue is well-formed

            IMPORTANT: Do NOT add comments to the issue. Only update labels and metadata.

            ## Execution order
            1. Read the issue and classify it
            2. Add labels with `gh issue edit`
          claude_args: '--allowedTools "Bash(gh issue:*),Bash(gh api:*),Read,Glob,Grep,Task,Write"'
